name: Deploy Production

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    env:
      DEPLOY_ENV: production
      IMAGE_NAME: ghcr.io/${{ github.repository }}/backend
      RETAIN_TAG_COUNT: "30"
    steps:
      - uses: actions/checkout@v4

      - name: Resolve image tag
        id: vars
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            short_sha=$(echo "${GITHUB_SHA}" | cut -c1-7)
            echo "tag=${DEPLOY_ENV}-${short_sha}" >> "$GITHUB_OUTPUT"
          fi
          short_sha=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt
      - name: Validate migrations
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          alembic upgrade head

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            frontend/package-lock.json
      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
      - name: Build agent
        working-directory: agent
        run: |
          npm install
          npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ steps.vars.outputs.tag }}
          path: frontend/build
      - name: Upload agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-dist-${{ steps.vars.outputs.tag }}
          path: agent/dist

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build -t "${IMAGE_NAME}:${{ steps.vars.outputs.tag }}" backend
          docker tag "${IMAGE_NAME}:${{ steps.vars.outputs.tag }}" "${IMAGE_NAME}:${GITHUB_SHA}"
          docker push "${IMAGE_NAME}:${{ steps.vars.outputs.tag }}"
          docker push "${IMAGE_NAME}:${GITHUB_SHA}"

      - name: Publish build metadata
        run: |
          cat > build-metadata.json << EOF
          {
            "environment": "${DEPLOY_ENV}",
            "image": "${IMAGE_NAME}",
            "image_tag": "${{ steps.vars.outputs.tag }}",
            "sha": "${GITHUB_SHA}",
            "retention": "keep_last_${RETAIN_TAG_COUNT}"
          }
          EOF
      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata-${{ steps.vars.outputs.tag }}
          path: build-metadata.json

      - name: Rollback strategy stub
        run: |
          {
            echo "Rollback strategy: redeploy the previous stable image tag from the registry.";
            echo "Retention policy stub: keep last ${RETAIN_TAG_COUNT} tags for production.";
          } >> "$GITHUB_STEP_SUMMARY"